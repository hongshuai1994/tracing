# 腾讯文档与企微文档的融合

## 融合之前，文档和企微的相互联系

- 腾讯文档侧
  - 文档把企微作为IDaaS，提供通过企微登陆文档的能力，且可以利用企微的组织架构信息实现组织内at人及设置权限
- 企微侧
  - 企微侧有自己的微文档和微盘，c++技术栈，从企微侧看来，腾讯文档和企微没有关系
  - 但是企微微文档腾讯文档的源头是一样的，都是QQ团队的在线文档，基于aText协议（类似于html和markdown表示格式，aText协议的格式更压缩），但是经历了2、3年的各自发展，功能上有了很多不同

### 融合要达成的目标

用户在企微中使用微文档的体验和用户使用企微登陆腾讯文档后的体验相同，功能一样、数据互通。

### 融合要解决的问题

融合要解决的问题有很多，下面单说下用户模块和文档管理要做的事情。

## 用户模块

1. __融合前腾讯文档是通过接入企微开放平台做到通过企微登陆文档的，接入企微的不同应用拿到的企微开平颁发的用户openID不一样，要想做到文档、企微、会议、日历等应用之间的账号互通，就需要有一个互认的ID，怎么实现呢？如何保证ID互通后的安全性呢？__
   1. 把企微作为账号平台，提供颁发用户ID和账号互通时中间票据的能力
   2. 需要改造用户通过企微扫码登陆文档时的流程、需要支持在企微登陆后，通过企微登陆态换文档登陆态的能力
      1. 企微提供二维码不变，用户企微扫码后，企微会根据当前用户是否已迁移决定回调文档的不同接口，文档处理新旧回调，走不通的登陆流程，跳转不同的首页
2. __前端web页面在功能上融合后，有一些请求是请求到企微微文档微盘后台的，有一些是请求到腾讯文档后台的，如何做到微文档和腾讯文档的登录态互通呢？__
   1. 企微用户如何打开企微文档？
      1. 需要双票，微文档票据和文档票据
      2. 用户通过企微登陆后，文档票据自然获得，但是微文档票据无，需要找企微颁发中间票据，调用微文档接口获取登录态，然后种到前段
   2. 微信用户，譬如文档小程序如何打开企微文档呢？
      1. 需要双票，微文档票据和文档票据，类似的
   3. 双票登录态的问题
      1. 双票有很多问题
         1. 资源和体验：校验登录态或者颁发登录态的时候，都需要微文档和文档同时参与，而且校验登陆台是个极其频繁的操作，每天要进行几亿次，如果只有一个票就可以减少请求次数，节省资源带宽和提高体验
         2. 理解和维护成本：微文档的登陆是3个字段，文档的登陆态是2个字段，仅登陆态就占了5个cookie kv，且一个登陆态能力由两个部门维护，有点奇怪
         3. 有优化的空间，但是需要时间
      2. 单票登录态
         1. 文档让步，登陆交给微文档去做，后续实现的PC/Mac上，只要登陆了企微，就可以直接登陆web文档的能力就是他们做的，登陆交给微文档去做，登陆后只颁发微文档的登陆，文档侧需要校验登陆态的地方把请求路由到微文档侧去校验
3. __其他小问题，文档侧的用户信息，无论是接入微信开平还是企微开平，都是需要缓存用户信息的，等用户再授权登陆的时候去更新，融合后还要存储吗？__
   1. 保留了，获取用户信息必要但不关键，几乎所有场景都需要获取用户信息，异步更新用户信息，缓存但是也存了用户信息

## 文档管理

1. __融合前企微文档和腾讯文档数据是不互通的，融合后如何互通呢？__
   1. 功能如何互通
      1. 文档的Q盘和微文档的微盘只留一个，用微盘，微盘的企业权限更完善，且更符合原先企业用户的使用习惯
      2. 前端功能融合，一部分请求到文档后台，一部分请求到微文档后台，到文档后台的请求，一部分要路由到微文档后台去处理
   2. 数据如何迁移
      1. 离线迁移（把文档的数据迁移到微盘），数据量不大，18w家企业，2000w用户，1500w篇文档，迁移正文和文档元数据
         1. 迁移期间，用户无法登陆，提示系统升级
      2. 迁移过程：
         1. 确定迁移范围（按公司按部门确定要迁移的人）
         2. 剔除登录态且限制登陆
         3. 获取用户所有目录信息，开始逐文档迁移
            1. 建立新的文档
            2. 记录新旧文档映射关系
            3. 迁移正文（正文每天会进行离线任务预迁移，迁移时只需迁移未迁移剩余版本即可）
            4. 文档属性迁移
            5. 记录失败文档，成功迁移的标志成功，失败的逐文档手动检查错误原因，并重试或丢弃
            6. 放开登陆，且登陆使用新的登陆方式
2. __如何把对C侧的影响降到最低？__
   1. 抽了一层代理层出来，兼容以前的所有drive协议，在proxy中不同的请求根据不同用户id、文档id、domain等进行请求的路由，譬如createFile请求，如果id是B用户id，则要把请求路由到微文档去创建
   2. 将来如果私有化时，需要接入除Q盘外的其他盘，也能收敛变更到proxy服务中

## 除技术外的其他问题

1. __跨BG沟通，技术目标总是可以达成的，最重要的是人与人合作的问题，腾讯文档PCG，企业微信WXG，腾讯会议CSIG，如何减少沟通中出现的问题？__
   1. 保证充足的上下文：涉及多方的技术方案要放到一篇文档，多方review，有变更要及时通知到人
   2. 几十人的会议如何提效：提前拉群，丢文档，先异步的基于文档讨论，确定争议点，如需拉会讨论
   3. 腾讯不同BG之前和不同的公司基本上没区别，做事风格和习惯很不一样
2. __技术方案有争议时怎么办？__
   1. 譬如融合文档第二版的用户模块方案，要文档把用户模块交出去给企微，方案各有优缺点的时候，讲明白找总监拍板
   2. 大多数争议都是过程，讲明白了一般都会有一版方案胜出的，譬如文档和会议合作时，会议要内嵌文档演示能力，需要给所有在会的人自动赋予查看文档的权限，就要把会议的登陆态转成文档登陆态，然后给对应文档用户赋权，方式是会议找企微颁发commonID（vid）和code，给文档，文档拿commonID和code找企微消费，获取到对应用户id，但是这个code只能消费一次，争议点是文档消费这个code还是微文档消费，不消费的一方，就要无条件相信消费的一方提供的信息，微文档以安全性为由不让步，最终文档让步了，也可以再复制一次刚刚的过程，找企微再颁发一次code，文档再消费一把，但是一来一回增加了时耗，链路变得更长了，增加了不稳定性，因为消费code后是纯后台请求了，就提供了裸接口，类似这样的吧
3. __全流程联调的质量如何保证？__
   1. 完善的UT，流水线会卡，75%，后来放开了，靠自觉了
   2. 必须要写E2E测试，这个纯靠自觉了，流水线是支持的，核心流程要写E2E
      1. ping测试，敲下门，有人回应
      2. 正常响应测试，门里的人是正确的人
      3. 错误响应测试，门里的人是错误的人
